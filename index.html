<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ParaDivide</title>
    <style>
        * {
            box-sizing: border-box;
        }

        /* Define theme variables */
        :root {
            --font-family: 'Roboto', sans-serif;
            --font-size: 23px;
            --line-height: 1.4;
            --text-color: #e6ddd1;
            --editable-bg: #0d0d0d;
            --readonly-bg: #202123;
            --readonly-color: #d1cec9;
            --border-color: #ccc;
            --focus-border-color: rgba(255, 255, 255, 0.2);
            --shadow-color: rgba(0, 0, 0, 1);
            --toolbar-bg: black;
            --toolbar-shadow: rgba(255, 0, 0, 0.2);
            --overlay-bg: rgba(0, 0, 0, 0.85);
            --link-color: #1e90ff;
            --link-hover-color: #63b3ed;
            --expanded-bg-gradient: linear-gradient(to right, rgba(0,0,0,0.5), rgba(0,0,0,0) 50px, rgba(0,0,0,0) calc(100% - 50px), rgba(0,0,0,0.5));
            --expanded-column2-bg-gradient: linear-gradient(to right, rgba(0,0,0,0.7), rgba(0,0,0,0) 50px, rgba(0,0,0,0) calc(100% - 50px), rgba(0,0,0,0.7));
        }

        [data-theme="dark"] {
            color-scheme: dark;
        }

        [data-theme="day"] {
            --text-color: #333333;
            --editable-bg: #ffffff;
            --readonly-bg: #f5f5f5;
            --readonly-color: #4a4a4a;
            --border-color: #999999;
            --focus-border-color: rgba(0, 0, 0, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --toolbar-bg: #ffffff;
            --toolbar-shadow: rgba(0, 0, 0, 0.2);
            --overlay-bg: rgba(255, 255, 255, 0.85);
            --link-color: #0066cc;
            --link-hover-color: #3399ff;
            --expanded-bg-gradient: linear-gradient(to right, rgba(255,255,255,0.5), rgba(255,255,255,0) 50px, rgba(255,255,255,0) calc(100% - 50px), rgba(255,255,255,0.5));
            --expanded-column2-bg-gradient: linear-gradient(to right, rgba(255,255,255,0.7), rgba(255,255,255,0) 50px, rgba(255,255,255,0) calc(100% - 50px), rgba(255,255,255,0.7));
            color-scheme: light;
        }

        [data-theme="teal"] {
            --text-color: #e6ddd1;
            --editable-bg: #253542 ;
            --readonly-bg: #141e28;
            --readonly-color: #c4cbd0;
            --border-color: #4a5e74;
            --focus-border-color: rgba(196, 203, 208, 0.2);
            --shadow-color: rgba(19, 29, 39, 0.5);
            --toolbar-bg: #111b24;
            --toolbar-shadow: rgba(19, 29, 39, 0.5);
            --overlay-bg: rgba(19, 29, 39, 0.85);
            --link-color: #4fc3f7;
            --link-hover-color: #81d4fa;
            --expanded-bg-gradient: linear-gradient(to right, rgba(19,29,39,0.5), rgba(19,29,39,0) 50px, rgba(19,29,39,0) calc(100% - 50px), rgba(19,29,39,0.5));
            --expanded-column2-bg-gradient: linear-gradient(to right, rgba(19,29,39,0.7), rgba(19,29,39,0) 50px, rgba(19,29,39,0) calc(100% - 50px), rgba(19,29,39,0.7));
            color-scheme: light;
        }

        [data-theme="teal"] .button-container button {
            background-color: #36495a;
            color: #ffffff;
        }

        @font-face {
            font-family: 'Roboto';
            src: url('/home/amnesia/Persistent/Tor Browser/font/RobotoCondensed-VariableFont_wght.ttf')
        }

        body {
            font-family: var(--font-family);
            font-size: var(--font-size);
            line-height: var(--line-height);
            color: var(--text-color);
            display: flex;
            justify-content: flex-start;
            height: 100vh;
            margin: 0;
            position: relative;
            background-color: transparent; /* Ensure no white background in Dark/Day themes */
        }

        [data-theme="teal"] body {
            background-color: #131d27; /* Specified background for Teal theme */
        }

        [data-theme="day"] body {
            background-color: #f0f0f0; /* Light background for Day theme to match cells */
        }

        /* Container for columns 1 and 2 */
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: repeat(100, auto);
            gap: 0px;
            padding: 3.5px;
            overflow-y: auto;
            width: 70%;
            margin-right: 0px;
            max-height: 100vh;
            transition: all 0.3s ease;
            z-index: 1;
        }

        .grid-item {
            padding: 10px;
            border: 1px solid var(--border-color);
        }

        .editable {
            background-color: var(--editable-bg);
            box-shadow: inset 0 7px 12px var(--shadow-color);
        }
        .editable:focus {
            outline: none;
            border: 1px solid var(--focus-border-color); /* Very dim border for focus */
        }

        .readonly {
            background-color: var(--readonly-bg);
            color: var(--readonly-color);
        }

        /* Fixed third column */
        .column-3 {
            position: relative;
            width: 30%;
            max-height: 100vh;
            overflow-y: auto;
            padding: 3.5px;
            border: 1px solid var(--border-color);
            display: grid;
            grid-template-rows: repeat(100, auto);
            transition: all 0.3s ease;
            z-index: 1;
        }

        /* Expanded column styles */
        .expanded-column-1 {
            width: 100% !important;
            margin: 0;
            z-index: 1000;
            position: relative;
            padding: 50px 50px 0 50px;
            background: var(--expanded-bg-gradient);
        }
        .expanded-column-2 {
            width: 100% !important;
            margin: 0;
            z-index: 1000;
            position: relative;
            padding: 50px 50px 0 50px;
            background: var(--expanded-column2-bg-gradient);
        }
        .expanded-column-3 {
            width: 100% !important;
            margin: 0;
            z-index: 1000;
            position: relative;
            padding: 50px 50px 0 50px;
            background: var(--expanded-bg-gradient);
        }

        /* Hide other columns when one is expanded */
        .column-hidden {
            display: none;
        }

        /* Show only specific column */
        .show-only-column-1 .grid-item:nth-child(even) {
            display: none;
        }

        .show-only-column-2 .grid-item:nth-child(odd) {
            display: none;
        }

        /* Fixed buttons and counters on top */
        .button-container {
            position: fixed;
            transform: translate(-50%, -50%);
            top: 3%;
            left: 50%;
            display: flex;
            flex-wrap: nowrap;
            gap: 0.5rem; /* Reduced gap to prevent wrapping */
            font-weight: 700;
            background-color: var(--toolbar-bg);
            border: 1px solid var(--border-color);
            padding: 0.2rem 0.5rem; /* Fixed padding in rem */
            box-shadow: 3px 2px 2px var(--toolbar-shadow);
            z-index: 2000;
            min-width: 24rem; /* Increased to accommodate theme toggle button */
            font-size: 1rem; /* Base font size to counteract zoom */
        }

        .button-container button {
            margin: 0.2rem;
            font-size: 0.9rem; /* Fixed size to counteract zoom */
            font-weight: bold;
            line-height: 1.2;
            padding: 0.3rem 0.6rem; /* Fixed padding */
        }

        .expand-button {
            width: 1.8rem; /* Fixed size */
            height: 1.8rem;
            font-size: 0.8rem; /* Fixed size */
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .expand-group {
            display: flex;
            gap: 0px;
        }

        /* Counter style */
        .counter {
            display: flex;
            flex-direction: row; /* Changed to row to keep counter in one line */
            align-items: center;
            gap: 0.3rem;
            font-size: 1.2rem; /* Reduced size to fit */
            white-space: nowrap; /* Prevent wrapping */
        }

        .column-1-cell {
        }

        /* Image thumbnail styles */
        .thumb {
            display: inline-block;
            width: 1.2em;
            height: 1.2em;
            cursor: pointer;
            vertical-align: middle;
            margin: 0 2px;
        }

        .thumb::before {
            content: "üñºÔ∏è";
            font-size: 1em;
        }

        /* Overlay styles */
        #overlay {
            position: fixed;
            inset: 0;
            background: var(--overlay-bg);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        #overlay img {
            max-width: 90%;
            max-height: 90%;
            box-shadow: 0 0 20px var(--shadow-color);
        }

        /* Style for clickable links */
        a {
            color: var(--link-color);
            text-decoration: underline;
            cursor: pointer;
        }

        a:hover {
            color: var(--link-hover-color);
        }

        @media (max-width: 1200px) {
            body {
                flex-direction: column;
            }

            .grid-container, .column-3 {
                width: 100%;
                height: 100%;
                margin-right: 0;
            }
        }
    </style>
</head>
<body>

    <!-- Image overlay -->
    <div id="overlay" onclick="this.style.display='none'"><img></div>

    <div class="button-container">
        <button onclick="formatText('bold')">ùêÅ</button>
        <button onclick="formatText('italic')">ùêà</button>
        <input type="file" id="fileInput" style="display: none;" />
        
        <!-- Word and Sentence Counter -->
        <div class="counter">
            <div><span id="wordCount">0</span> / <span id="sentenceCount">0</span></div>
        </div>
        <button onclick="saveData()">üíæ</button>
        <button onclick="snatchData()">‚úÇÔ∏è</button>
        <button onclick="loadData()">üìÇ</button>
        <button onclick="toggleTheme()">üåó</button>
        <div class="expand-group">
            <button class="expand-button" onclick="toggleExpand(1)">1</button>
            <button class="expand-button" onclick="toggleExpand(2)">2</button>
            <button class="expand-button" onclick="toggleExpand(3)">3</button>
        </div>
    </div>

    <!-- First and Second Column -->
    <div class="grid-container" id="grid">
        <!-- Columns 1 and 2 will be generated via JavaScript -->
    </div>

    <!-- Third Column -->
    <div class="column-3" id="column-3">
        <!-- Odd and even rows in Column 3 generated dynamically -->
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script>
        const grid = document.getElementById('grid');
        const column3 = document.getElementById('column-3');

        // Theme toggle functionality
        const themes = ['dark', 'day', 'teal'];
        let currentThemeIndex = 0;

        function toggleTheme() {
            currentThemeIndex = (currentThemeIndex + 1) % themes.length;
            document.documentElement.setAttribute('data-theme', themes[currentThemeIndex]);
        }

        let currentRow = null;
        let column3Data = {};
        const wordCountSpan = document.getElementById('wordCount');
        const sentenceCountSpan = document.getElementById('sentenceCount');

        // Image viewer variables
        let overlay = document.getElementById("overlay");
        let big = overlay.querySelector("img");
        let images = [];
        let current = 0;

        // Word and sentence limits
        const maxWordsColumn1 = 1000;
        const maxSentencesColumn1 = 50;
        const maxWordsColumn3Even = 1000;
        const maxSentencesColumn3Even = 50;

        let currentExpanded = null;

        // Function to toggle column expansion
        function toggleExpand(column) {
            const gridContainer = document.getElementById('grid');
            const column3Container = document.getElementById('column-3');

            if (currentExpanded === column) {
                // Reset to default
                currentExpanded = null;
                gridContainer.classList.remove('expanded-column-1', 'expanded-column-2', 'show-only-column-1', 'show-only-column-2', 'column-hidden');
                gridContainer.style.gridTemplateColumns = '1fr 1fr';
                column3Container.classList.remove('expanded-column-3', 'column-hidden');
            } else {
                // Reset first
                gridContainer.classList.remove('expanded-column-1', 'expanded-column-2', 'show-only-column-1', 'show-only-column-2', 'column-hidden');
                gridContainer.style.gridTemplateColumns = '1fr 1fr';
                column3Container.classList.remove('expanded-column-3', 'column-hidden');

                currentExpanded = column;

                if (column === 1) {
                    gridContainer.classList.add('expanded-column-1', 'show-only-column-1');
                    gridContainer.style.gridTemplateColumns = '1fr';
                    column3Container.classList.add('column-hidden');
                } else if (column === 2) {
                    gridContainer.classList.add('expanded-column-2', 'show-only-column-2');
                    gridContainer.style.gridTemplateColumns = '1fr';
                    column3Container.classList.add('column-hidden');
                } else if (column === 3) {
                    column3Container.classList.add('expanded-column-3');
                    gridContainer.classList.add('column-hidden');
                }
            }
        }

        // Toolbar buttons for formatting (bold and italic)
        function formatText(command) {
            document.execCommand(command, false, null);
        }

        // Function to count words in a string
        function countWords(text) {
            return text.replace(/\n+/g, ' ').trim().split(/\s+/).filter(word => word.length > 0).length;
        }

        // Function to count sentences in a string
        function countSentences(text) {
            return text.split(/[.!?]+/).filter(sentence => sentence.trim().length > 0).length;
        }

        // Update word and sentence counters
        function updateCounters(text) {
            const wordCount = countWords(text);
            const sentenceCount = countSentences(text);
            wordCountSpan.textContent = wordCount;
            sentenceCountSpan.textContent = sentenceCount;
        }

        // Function to enforce word and sentence limits
        function enforceLimits(element, isColumn1) {
            const text = element.textContent.replace(/\n+/g, ' ').trim();
            const wordCount = countWords(text);
            const sentenceCount = countSentences(text);
            const maxWords = isColumn1 ? maxWordsColumn1 : maxWordsColumn3Even;
            const maxSentences = isColumn1 ? maxSentencesColumn1 : maxSentencesColumn3Even;

            if (wordCount > maxWords || sentenceCount > maxSentences) {
                const trimmedText = text
                    .split('.')
                    .map(sentence => sentence.trim())
                    .slice(0, maxSentences)
                    .join('. ') + '.'
                    .split(/\s+/)
                    .slice(0, maxWords)
                    .join(' ');

                element.textContent = trimmedText.trim();
            }
        }

        // Image viewer functions
        function openImage(imageSrc) {
            let index = images.indexOf(imageSrc);
            if (index === -1) {
                images.push(imageSrc);
                index = images.length - 1;
            }
            
            current = index;
            big.src = images[current];
            overlay.style.display = "flex";
        }

        // Rebind all thumb click handlers
        function rebindThumbs() {
            document.querySelectorAll('.thumb').forEach(thumb => {
                thumb.onclick = null;
                
                thumb.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const imageSrc = this.dataset.src;
                    if (imageSrc) {
                        openImage(imageSrc);
                    }
                };
            });
        }

        // Function to convert URLs to clickable links
        function makeURLsClickable(text) {
            const urlRegex = /(https?:\/\/[^\s<]+)(?![^<]*>)/g;
            return text.replace(urlRegex, '<a href="$1" target="_blank">$1</a>');
        }

        // Function to process URLs in editable content without affecting existing HTML
        function processURLsInContent(element) {
            const selection = window.getSelection();
            let range;
            if (selection.rangeCount > 0) {
                range = selection.getRangeAt(0).cloneRange();
            }

            const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null, false);
            let node;
            while ((node = walker.nextNode())) {
                const text = node.textContent;
                if (text.match(/(https?:\/\/[^\s]+)/)) {
                    const parent = node.parentNode;
                    if (parent.tagName !== 'A') {
                        const newHTML = makeURLsClickable(text);
                        if (newHTML !== text) {
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = newHTML;
                            while (tempDiv.firstChild) {
                                parent.insertBefore(tempDiv.firstChild, node);
                            }
                            parent.removeChild(node);
                        }
                    }
                }
            }

            if (range) {
                selection.removeAllRanges();
                selection.addRange(range);
            }
        }

        // Function to split sentences preserving brackets and making URLs clickable inside them
        function splitSentencesWithURLs(html) {
            const bracketRegex = /\[([^\]]+)\]/g;
            let bracketMap = new Map();
            let placeholderIndex = 0;

            // Replace brackets with placeholders
            const textWithBracketPlaceholders = html.replace(bracketRegex, (match, content) => {
                const placeholder = `__BRACKET_${placeholderIndex}__`;
                bracketMap.set(placeholder, '[' + makeURLsClickable(content) + ']');
                placeholderIndex++;
                return placeholder;
            });

            // Split by sentence-ending punctuation
            let sentences = textWithBracketPlaceholders.split(/\.\s*/).filter(s => s.trim() !== '');

            // Restore brackets in sentences
            sentences = sentences.map(sentence => {
                let restored = sentence;
                bracketMap.forEach((content, placeholder) => {
                    restored = restored.replace(placeholder, content);
                });
                return restored;
            });

            return sentences;
        }

        // Handle paste events for images and text
        document.addEventListener("paste", e => {
            let hasImage = false;
            const pastedText = e.clipboardData.getData('text/plain');
            const hasText = !!pastedText;

            [...e.clipboardData.items].forEach(item => {
                if (item.type.startsWith("image")) {
                    hasImage = true;
                    e.preventDefault();
                    
                    const file = item.getAsFile();
                    const reader = new FileReader();
                    
                    reader.onload = function(event) {
                        const imageSrc = event.target.result;
                        
                        // Check if the image already exists in the images array
                        if (images.includes(imageSrc)) {
                            // Reuse existing image
                            const thumbHtml = `<span class="thumb" data-src="${imageSrc}"></span>&nbsp;`;
                            document.execCommand('insertHTML', false, thumbHtml);
                        } else {
                            // Add new image
                            images.push(imageSrc);
                            const thumbHtml = `<span class="thumb" data-src="${imageSrc}"></span>&nbsp;`;
                            document.execCommand('insertHTML', false, thumbHtml);
                        }
                        
                        setTimeout(() => {
                            const selection = window.getSelection();
                            const activeElement = document.activeElement;
                            
                            if (activeElement && activeElement.contentEditable === 'true') {
                                const range = document.createRange();
                                range.selectNodeContents(activeElement);
                                range.collapse(false);
                                
                                selection.removeAllRanges();
                                selection.addRange(range);
                            }
                        }, 10);
                        
                        rebindThumbs();
                    };
                    
                    reader.readAsDataURL(file);
                }
            });

            if (hasText && !hasImage) {
                e.preventDefault();
                const htmlText = makeURLsClickable(pastedText.replace(/\n/g, '<br>'));
                document.execCommand('insertHTML', false, htmlText);
                const activeElement = document.activeElement;
                if (activeElement && activeElement.contentEditable === 'true') {
                    processURLsInContent(activeElement);
                }
            }
        });

        // Handle clicks on links in all cells
        document.addEventListener('click', function(e) {
            if (e.target.tagName === 'A') {
                e.preventDefault();
                window.open(e.target.href, '_blank');
            }
        });

        // Keyboard navigation for image overlay
        document.addEventListener("keydown", e => {
            if (overlay.style.display === "flex") {
                if (e.key === "Escape") overlay.style.display = "none";
                if (e.key === "ArrowRight") {
                    current = (current + 1) % images.length;
                    big.src = images[current];
                }
                if (e.key === "ArrowLeft") {
                    current = (current - 1 + images.length) % images.length;
                    big.src = images[current];
                }
            }
        });

        // Generate 100 rows, 2 columns in the grid (Column 1 and 2)
        for (let i = 0; i < 100; i++) {
            const editableCell = document.createElement('div');
            editableCell.classList.add('grid-item', 'editable', 'column-1-cell');
            editableCell.contentEditable = true;
            editableCell.dataset.row = i;
            grid.appendChild(editableCell);

            const column2Cell = document.createElement('div');
            column2Cell.classList.add('grid-item', 'readonly');
            column2Cell.dataset.row = i;
            grid.appendChild(column2Cell);

            const column3OddCell = document.createElement('div');
            column3OddCell.classList.add('grid-item', 'readonly');
            column3OddCell.contentEditable = false;
            column3OddCell.dataset.row = i;
            column3.appendChild(column3OddCell);

            const column3EvenCell = document.createElement('div');
            column3EvenCell.classList.add('grid-item', 'editable');
            column3EvenCell.contentEditable = true;
            column3EvenCell.dataset.row = i;
            column3.appendChild(column3EvenCell);

            editableCell.addEventListener('focus', function () {
                currentRow = i;
                updateCounters(editableCell.textContent);
                const sentences = splitSentencesWithURLs(editableCell.innerHTML);
                
                for (let j = 0; j < 100 * 2; j++) {
                    column3.children[j].innerHTML = "";
                }

                for (let j = 0; j < sentences.length; j++) {
                    if (j === sentences.length - 1) {
                        column3.children[j * 2].innerHTML = sentences[j].trim();
                    } else {
                        column3.children[j * 2].innerHTML = sentences[j].trim() + '.';
                    }
                }

                if (column3Data[currentRow]) {
                    for (let j = 0; j < column3Data[currentRow].length; j++) {
                        column3.children[j * 2 + 1].innerHTML = column3Data[currentRow][j];
                    }
                }
                
                rebindThumbs();
            });

            editableCell.addEventListener('input', function () {
                enforceLimits(editableCell, true);
                updateCounters(editableCell.textContent);
                processURLsInContent(editableCell);
                rebindThumbs();
            });

            column3EvenCell.addEventListener('focus', function () {
                updateCounters(column3EvenCell.textContent);
            });

            column3EvenCell.addEventListener('input', function () {
                enforceLimits(column3EvenCell, false);
                updateCounters(column3EvenCell.textContent);
                processURLsInContent(column3EvenCell);
                
                if (currentRow !== null) {
                    let evenCellsContent = [];
                    let orderedContent = [];
                    let secondColumnContent = [];
                    let naturalOrderIndex = 0;

                    function stripHTMLTags(html) {
                        const div = document.createElement('div');
                        div.innerHTML = html;
                        return div.textContent || div.innerText || '';
                    }

                    for (let j = 1; j < 100 * 2; j += 2) {
                        let content = column3.children[j].innerHTML.trim();
                        evenCellsContent.push(content);

                        let plainTextContent = stripHTMLTags(content);
                        let match = plainTextContent.match(/^(\d+)\s*(.*)/);
                        if (match) {
                            let orderIndex = parseInt(match[1]);
                            let contentWithoutPrefix = content.replace(/^(\d+)\s*/, '');
                            orderedContent.push({ orderIndex, content: contentWithoutPrefix });
                        } else {
                            secondColumnContent.push(content);
                        }
                    }

                    orderedContent.sort((a, b) => a.orderIndex - b.orderIndex);

                    for (let j = 1; j < 100 * 2; j += 2) {
                        let content = column3.children[j].innerHTML.trim();
                        if (content !== "") {
                            let plainTextContent = stripHTMLTags(content);
                            let match = plainTextContent.match(/^(\d+)\s*(.*)/);
                            if (!match) {
                                while (orderedContent[naturalOrderIndex] !== undefined) {
                                    naturalOrderIndex++;
                                }
                                orderedContent.push({ orderIndex: naturalOrderIndex, content });
                                secondColumnContent = secondColumnContent.filter(item => item !== content);
                            }
                        }
                    }

                    let finalOrderedContent = orderedContent.map(item => item.content).concat(secondColumnContent);
                    grid.children[currentRow * 2 + 1].innerHTML = finalOrderedContent.length > 0 ? finalOrderedContent.join(' ') : '';
                    column3Data[currentRow] = evenCellsContent;
                    
                    rebindThumbs();
                }
            });
        }

        // Save editable data to a TXT file
        function saveData() {
            const data = [];
            // Collect unique image data URLs to include at the end of the file
            const uniqueImages = [...new Set(images)];

            for (let i = 0; i < 100; i++) {
                const column1Content = grid.children[i * 2].innerHTML;

                if (column3Data[i]) {
                    let lastFilledIndex = -1;
                    
                    for (let j = 0; j < column3Data[i].length; j++) {
                        if (column3Data[i][j].trim() !== '') {
                            lastFilledIndex = j;
                        }
                    }

                    let evenCellsContent = [];
                    for (let j = 0; j <= lastFilledIndex; j++) {
                        evenCellsContent.push(column3Data[i][j].trim() !== '' ? column3Data[i][j] : 'EMPTY.');
                    }
                    data.push(`Row ${i + 1} Column 1): ${column1Content}`);
                    data.push(`Row ${i + 1} Column 3 (Even): ${evenCellsContent.join('. ')}`);
                } else {
                    data.push(`Row ${i + 1} Column 1): ${column1Content}`);
                    data.push(`Row ${i + 1} Column 3 (Even): EMPTY.`);
                }
            }

            // Append unique images to the saved file
            if (uniqueImages.length > 0) {
                data.push('\nImages:');
                uniqueImages.forEach((imageSrc, index) => {
                    data.push(`Image ${index + 1}: ${imageSrc}`);
                });
            }

            const now = new Date();
            const timestamp = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}-${String(now.getMinutes()).padStart(2, '0')}-${String(now.getSeconds()).padStart(2, '0')}`;
            const firstCellContent = grid.children[0].textContent.trim().split(' ')[0] || 'grid_data';
            const filename = `${firstCellContent}_${timestamp}.txt`;

            const blob = new Blob([data.join('\n')], { type: 'text/plain;charset=utf-8' });
            saveAs(blob, filename);
        }

        // Save Column 2 content as Column 1 into a TXT file
        function snatchData() {
            const data = [];

            for (let i = 0; i < 100; i++) {
                const column2Content = grid.children[i * 2 + 1].innerHTML;
                data.push(`Row ${i + 1} Column 1): ${column2Content}`);
                data.push(`Row ${i + 1} Column 3 (Even): EMPTY.`);
            }

            const now = new Date();
            const timestamp = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}-${String(now.getMinutes()).padStart(2, '0')}-${String(now.getSeconds()).padStart(2, '0')}`;
            const firstCellContent = grid.children[0].textContent.trim().split(' ')[0] || 'grid_data';
            const filename = `snatch_${firstCellContent}_${timestamp}.txt`;

            const blob = new Blob([data.join('\n')], { type: 'text/plain;charset=utf-8' });
            saveAs(blob, filename);
        }

        // Load data from a TXT file
        function loadData() {
            const input = document.getElementById('fileInput');
            input.click();
            input.addEventListener('change', function () {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = function () {
                    const lines = reader.result.split('\n');
                    column3Data = {};
                    images = [];

                    // Clear all columns before loading
                    for (let i = 0; i < 100; i++) {
                        grid.children[i * 2].innerHTML = ''; // Clear Column 1
                        grid.children[i * 2 + 1].innerHTML = ''; // Clear Column 2
                        column3.children[i * 2].innerHTML = ''; // Clear Column 3 odd
                        column3.children[i * 2 + 1].innerHTML = ''; // Clear Column 3 even
                    }

                    let isImageSection = false;
                    lines.forEach((line, index) => {
                        if (line.startsWith('Images:')) {
                            isImageSection = true;
                            return;
                        }

                        if (isImageSection) {
                            const imageMatch = line.match(/^Image \d+: (.*)/);
                            if (imageMatch) {
                                images.push(imageMatch[1]);
                            }
                        } else {
                            const rowIndex = Math.floor(index / 2);
                            const content = line.split('): ')[1];

                            if (index % 2 === 0) {
                                grid.children[rowIndex * 2].innerHTML = content;
                            } else {
                                const evenCells = content.split('. ').map(cell => cell === 'EMPTY.' ? '' : cell);
                                column3Data[rowIndex] = evenCells;

                                for (let j = 0; j < evenCells.length; j++) {
                                    column3.children[rowIndex * 2 + 1 + j * 2].innerHTML = evenCells[j];
                                }

                                let orderedContent = [];
                                let naturalOrderContent = [];
                                let naturalOrderIndex = 0;

                                function stripHTMLTags(html) {
                                    const div = document.createElement('div');
                                    div.innerHTML = html;
                                    return div.textContent || div.innerText || '';
                                }

                                evenCells.forEach((cellContent) => {
                                    let plainTextContent = stripHTMLTags(cellContent);
                                    let match = plainTextContent.match(/^(\d+)\s*(.*)/);
                                    if (match) {
                                        let orderIndex = parseInt(match[1]);
                                        let contentWithoutPrefix = cellContent.replace(/^(\d+)\s*/, '');
                                        orderedContent.push({ orderIndex, content: contentWithoutPrefix });
                                    } else if (cellContent !== "") {
                                        naturalOrderContent.push(cellContent);
                                    }
                                });

                                orderedContent.sort((a, b) => a.orderIndex - b.orderIndex);

                                naturalOrderContent.forEach((cellContent) => {
                                    orderedContent.push({ orderIndex: naturalOrderIndex++, content: cellContent });
                                });

                                let finalOrderedContent = orderedContent.map(item => item.content);
                                grid.children[rowIndex * 2 + 1].innerHTML = finalOrderedContent.join(' ');
                            }
                        }
                    });
                    
                    document.querySelectorAll('.thumb').forEach(thumb => {
                        const src = thumb.dataset.src;
                        if (src && !images.includes(src)) {
                            images.push(src);
                        }
                    });
                    rebindThumbs();
                };
                reader.readAsText(file);
            });
        }

        // Scroll functions
        function adjustEditablePositionOnFocus() {
            const editables = document.querySelectorAll('.editable');
            editables.forEach(editable => {
                editable.addEventListener('focus', () => {
                    setTimeout(() => {
                        editable.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                });
            });
        }

        function adjustColumnThreeToTop() {
            const editables = document.querySelectorAll('.column-1-cell');
            editables.forEach(editable => {
                editable.addEventListener('focus', () => {
                    setTimeout(() => {
                        const column3 = document.querySelector('.column-3');
                        if (column3) {
                            column3.scrollTo({
                                top: 0,
                                behavior: 'smooth'
                            });
                        }
                    }, 300);
                });
            });
        }

        window.addEventListener('DOMContentLoaded', adjustEditablePositionOnFocus);      
        window.addEventListener('DOMContentLoaded', adjustColumnThreeToTop);     
        
        document.addEventListener('focusout', function(e) {
            if (e.target.classList.contains('editable')) {
                setTimeout(function() {
                    window.scrollTo(0, 0);
                }, 300);
            }
        });

        if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
            document.addEventListener('focusin', (e) => {
                if (e.target.classList.contains('editable')) {
                    window.scrollTo(0, e.target.offsetTop - 50);
                }
            });
        }

        // Initial rebind on page load
        document.addEventListener('DOMContentLoaded', rebindThumbs);
    </script>
</body>
</html>

